{"version":3,"sources":["index.js"],"names":[],"mappings":";;;;;;;AAAA","file":"index.js","sourcesContent":["!function(t,e){\"object\"==typeof exports&&\"object\"==typeof module?module.exports=e():\"function\"==typeof define&&define.amd?define([],e):\"object\"==typeof exports?exports.paddlejs=e():(t.paddlejs=t.paddlejs||{},t.paddlejs.core=e())}(this,(function(){return(()=>{var t={911:(t,e)=>{var r=function(){if(\"undefined\"!=typeof self)return self;if(\"undefined\"!=typeof window)return window;if(void 0!==r)return r;throw new Error(\"unable to locate global object\")}();t.exports=e=r.fetch,r.fetch&&(e.default=r.fetch.bind(r)),e.Headers=r.Headers,e.Request=r.Request,e.Response=r.Response},994:(t,e,r)=>{r.r(e),r.d(e,{PaddlejsBackend:()=>yt,Runner:()=>mt,Transformer:()=>k,coreUtils:()=>n,env:()=>p,interfaces:()=>i,registerBackend:()=>_,registerOp:()=>w});var n={};r.r(n),r.d(n,{AddItemToVars:()=>u,delUselessData:()=>c,findVarByKey:()=>o,getGlobalInterface:()=>s,getOrMakeGlobalProperty:()=>a,traverseVars:()=>h});var i={};function s(){var t;if(\"undefined\"!=typeof window)t=window;else if(void 0!==r.g)t=r.g;else{if(\"undefined\"==typeof self)throw new Error(\"Could not find a global object\");t=self}return t}function a(t,e){var r=s();return r[t]||(r[t]=e),r[t]}function o(t,e){return Array.isArray(t)?t.find((function(t){return t.name===e})):t[e]}function u(t,e){var r=Array.isArray(t),n=Array.isArray(e)?e:[e];r?n.forEach((function(e){for(var r=null,n=0;n<t.length;n++)if(t[n].name===e.name){r=n;break}null!==r?t[r]=e:t.push(e)})):n.forEach((function(e){t[e.name]=e}))}function h(t,e){Array.isArray(t)?t.forEach((function(t){e(t)})):Object.keys(t).forEach((function(r){e(t[r])}))}function c(t){if(t.ops=null,t.vars instanceof Array)for(var e=0;e<t.vars.length;e++)t.vars[e].data&&delete t.vars[e].data;else for(var r in t.vars)t.vars[r].data&&delete t.vars[r].data}r.r(i),r.d(i,{BufferType:()=>v,GraphType:()=>y,UniformType:()=>m,WasmMemoryType:()=>g});const p=a(\"env\",new(function(){function t(){this.ENV={}}return t.prototype.set=function(t,e){this.ENV[t]=e},t.prototype.get=function(t){return this.ENV[t]},t}()));var f=function(t,e,r,n){return new(r||(r=Promise))((function(i,s){function a(t){try{u(n.next(t))}catch(t){s(t)}}function o(t){try{u(n.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,o)}u((n=n.apply(t,e||[])).next())}))},l=function(t,e){var r,n,i,s,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},\"function\"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(s){return function(o){return function(s){if(r)throw new TypeError(\"Generator is already executing.\");for(;a;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((i=(i=a.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){a.label=s[1];break}if(6===s[0]&&a.label<i[1]){a.label=i[1],i=s;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(s);break}i[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,o])}}};const d=function(){function t(t){this.urlConf={dir:\"\",main:\"\"},this.separateChunk=!0,this.chunkNum=1,this.dataType=\"binary\",this.params={type:\"fetch\"},this.inNode=!1,this.isLocalFile=!1,this.realFetch=function(){throw new Error(\"ERROR: empty fetch funciton\")};var e=t,r=\"model.json\";if(t.endsWith(\".json\")){var n=t.lastIndexOf(\"/\")+1;e=t.substr(0,n),r=t.substr(n)}else\"/\"!==t.charAt(t.length-1)&&(e=t+\"/\");this.isLocalFile=0!==e.indexOf(\"http\"),this.urlConf={dir:this.isLocalFile?\"/\"===e.charAt(0)?\"\"+e:\"/\"+e:e,main:r},this.inNode=\"node\"===p.get(\"platform\")}return t.prototype.load=function(){return f(this,void 0,void 0,(function(){var e;return l(this,(function(r){switch(r.label){case 0:return[4,this.fetchModel()];case 1:return e=r.sent(),this.separateChunk=!!e.chunkNum&&e.chunkNum>0,this.chunkNum=this.separateChunk?e.chunkNum:0,this.separateChunk?\"binary\"!==this.dataType?[3,3]:[4,this.fetchChunks().then((function(r){return t.allocateParamsVar(e.vars,r)}))]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2,e]}}))}))},t.prototype.fetchOneChunk=function(t){return f(this,void 0,void 0,(function(){return l(this,(function(e){switch(e.label){case 0:return p.get(\"fetch\")?[4,p.get(\"fetch\")(t,{type:\"arrayBuffer\"})]:[3,2];case 1:return[2,e.sent()];case 2:return[2,this.fetch(t).then((function(t){return t.arrayBuffer()}))]}}))}))},t.prototype.fetchJson=function(t){return this.fetch(t).then((function(t){return t.json()}))},t.prototype.getFileName=function(t){return\"chunk_\"+t+\".dat\"},t.prototype.fetchChunks=function(){return f(this,void 0,void 0,(function(){var t,e,r;return l(this,(function(n){for(t=this.chunkNum,e=[],r=1;r<=t;r++)e.push(this.fetchOneChunk(this.urlConf.dir+this.getFileName(r)));return[2,Promise.all(e).then((function(t){var e,r=0,n=[];t.forEach((function(t){e=new Float32Array(t),n.push(e),r+=e.length}));var i=new Float32Array(r),s=0;return n.forEach((function(t){t.forEach((function(t){i[s]=t,s+=1}))})),i}))]}))}))},t.allocateParamsVar=function(t,e){var r,n=0;h(t,(function(t){r=t.shape.reduce((function(t,e){return t*e})),t.persistable&&(t.data=e.slice(n,n+r),n+=r)}))},t.prototype.fetch=function(t,e){if(p.get(\"fetch\"))return p.get(\"fetch\")(t,e||{});var n=(e||this.params).method||\"get\",i=new(this.inNode?r(911).Headers:Headers);return this.realFetch=this.inNode?this.isLocalFile?this.fetchLocalFile:r(911):window.fetch.bind(window),this.realFetch(t,{method:n,headers:i})},t.prototype.fetchLocalFile=function(t){var e=r(993);return new Promise((function(r,n){try{r(e.readFileSync(t,\"utf8\"))}catch(t){n(t)}}))},t.prototype.fetchModel=function(){var t=this,e=this.params,r=this.urlConf.dir+this.urlConf.main,n=null;return\"fetch\"===e.type&&(n=new Promise((function(n,i){t.fetch(r,e).then((function(e){return p.get(\"fetch\")?e:t.isLocalFile&&t.inNode?JSON.parse(e):e.json()})).then((function(t){return n(t)})).then((function(t){return i(t)}))}))),n},t}();var v,g,m,y;!function(t){t.FrameBuffer=\"frameBuffer\",t.ColorBuffer=\"colorBuffer\"}(v||(v={})),function(t){t.memory100=\"100\",t.memory200=\"200\",t.memory300=\"300\",t.memory400=\"400\",t.memory500=\"500\",t.memory600=\"600\",t.memory700=\"700\",t.memory800=\"800\",t.memory900=\"900\"}(g||(g={})),function(t){t.uniform1f=\"1f\",t.uniform1fv=\"1fv\",t.uniform1i=\"1i\",t.uniform1iv=\"1iv\",t.uniform2f=\"2f\",t.uniform2fv=\"2fv\",t.uniform2i=\"2i\",t.uniform2iv=\"2iv\",t.uniform3f=\"3f\",t.uniform3fv=\"3fv\",t.uniform3i=\"3i\",t.uniform3iv=\"3iv\",t.uniform4f=\"4f\",t.uniform4fv=\"4fv\",t.uniform4i=\"4i\",t.uniform4iv=\"4iv\"}(m||(m={})),function(t){t.SingleOutput=\"single\",t.MultipleOutput=\"multiple\",t.MultipleInput=\"multipleInput\"}(y||(y={}));var b={opRegistry:{ops:{}},backend:\"\",backendInstance:null};function w(t,e){var r=t.conf,n=t.params,i=t.main,s=t.mainFunc,a=t.textureFuncConf,o=t.commonFuncConf,u=t.behaviors,h=void 0===u?[]:u,c=b.backend+\"_\"+e;b.opRegistry.ops[c]||(b.opRegistry.ops[c]={name:e,conf:r,params:n,main:i,mainFunc:s,textureFuncConf:a,commonFuncConf:o,behaviors:h})}function _(t,e,r){t&&(b.backend=t),e&&(b.backendInstance=e),r&&Object.keys(r).forEach((function(t){w(r[t],t)}))}b=a(\"GLOBALS\",b);var A=s();A.ImageBitmap||(A.ImageBitmap=function(){});const x=function(){function t(t,e){this.id=\"\",this.type=\"\",this.inputs={},this.outputs={},this.attrs={},this.subAttrs=[],this.next=\"\",this.opData=null,this.isPacked=!1,this.bufferType=v.FrameBuffer,this.uniform=null;var r=t.inputs,n=t.outputs,i=t.attrs,s=void 0===i?{}:i,a=t.type,o=t.isPacked,u=void 0!==o&&o,h=t.bufferType,c=void 0===h?v.FrameBuffer:h,p=t.uniform,f=void 0===p?null:p;this.id=a+\"_\"+ +new Date+\"_\"+e,this.inputs=r,this.outputs=n,this.attrs=s,this.subAttrs=t[\"sub-attrs\"]||[],this.uniform=f,this.type=a,this.isPacked=u,this.bufferType=c,this.next=\"\",this.opData=null}return Object.defineProperty(t.prototype,\"inputsName\",{get:function(){var t=this,e=[];return Object.keys(this.inputs).forEach((function(r){e.push(t.inputs[r][0])})),e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,\"outputsName\",{get:function(){return this.outputs.Output||this.outputs.Out||this.outputs.Y},enumerable:!1,configurable:!0}),t.prototype.execute=function(t){b.backendInstance.runProgram(this.opData,t)},t}(),k=function(t){this.name=t};var O,P=(O=function(t,e){return(O=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}O(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),T={conv2d:function(t,e){var r=t.attrs.strides,n=t.inputs.Input[0],i=t.inputs.Filter[0];if(\"image\"===n)return!1;var s=o(e,n).shape,a=o(e,i).shape;return!r.find((function(t){return t>1}))&&s[s.length-1-2]%4==0&&4===a.length&&a[0]%4==0&&a[1]%4==0}};function M(t){return{type:\"packed_2_unpacked\",attrs:{},inputs:{Input:[t.inputName]},outputs:{Output:[t.outputName]}}}function j(t){return{type:\"unpacked_2_packed\",attrs:{},inputs:{Input:[t.inputName]},outputs:{Output:[t.outputName]}}}function E(t,e){Object.keys(t.inputs).forEach((function(e){t.inputs[e]=[t.inputs[e]+\"_packed\"]})),Object.keys(t.outputs).forEach((function(e){t.outputs[e]=[t.outputs[e]+\"_packed\"]})),t.type=t.type+\"_packing\",t.id=t.type+\"_\"+ +new Date+\"_\"+e.length,t.isPacked=!0}const F=function(t){function e(){return t.call(this,\"TexturePacking\")||this}return P(e,t),e.prototype.transform=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(\"webgl\"===b.backend&&p.get(\"webgl_pack_channel\")){var r=t[0],n=t[1],i=t[2],s=\"depthwise_conv2d\"===r.type?\"conv2d\":r.type,a=T[s];if(a&&a(r,n)){var o=r.inputs,u=r.outputs,h=o.Input[0],c=u.Output?u.Output[0]:u.Out[0],f=j({inputName:h,outputName:h+\"_packed\"}),l=i.length;i.push(new x(f,l)),E(r,i);var d=M({inputName:c+\"_packed\",outputName:c}),v=i.length+1;i.push(new x(d,v))}}},e}(k);var D=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();const N=function(t){function e(){return t.call(this,\"FormatInputsX\")||this}return D(e,t),e.prototype.transform=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t[0],n=[\"concat\",\"connect\",\"fc\",\"rnn_origin\",\"rnn_matmul\",\"stack\"];if(n.includes(r.type)){var i=r.inputs;if((\"rnn_origin\"===r.type||\"rnn_matmul\"===r.type)&&i.WeightList.length>0)i.WeightList.forEach((function(t,e){i[\"weightlist_\"+e]=[t]}));else{var s=i.X||i.Input;if(\"wasm\"!==p.get(\"backend\"))s.length>1&&(s.forEach((function(t,e){i[\"origin\"+(e>0?\"_\"+e:\"\")]=[t]})),delete i.X,delete i.Input);else{if(s.length>4)throw Error(\"Not yet supporting concat input tensors more than 4.\");if(s.length>1){var a=s[0],o=s[1],u=s[2],h=s[3];i.X=[a],o&&(i.Y=[o]),u&&(i.Z=[u],r.type+=\"_mul\"),h&&(i.M=[h])}}}}},e}(k);var S=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),C=function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),i=0;for(e=0;e<r;e++)for(var s=arguments[e],a=0,o=s.length;a<o;a++,i++)n[i]=s[a];return n};function I(t,e){var r=o(e,t);return r?r.shape:[]}function L(t,e,r,n){for(var i=C(e),s=0,a=0,o=t;a<o.length;a++)s+=I(o[a],n)[r];return i[r]=s,{name:t[t.length-1]+\"_out\",shape:i}}const R=function(t){function e(){return t.call(this,\"splitOp\")||this}return S(e,t),e.prototype.transform=function(){for(var t,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];for(var n=e[0],i=e[1],s=0,a=n.length;s<a;s++){var o=n[s];if(\"concat\"===o.type&&(null===(t=o.inputs)||void 0===t?void 0:t.X)&&!(o.inputs.X.length<=4)){var h=o.attrs,c=o.inputs,p=o.outputs,f=c.X,l=f.length,d=Math.ceil((l-4)/3)+1,v=p.Out[0],g=I(v,i),m=h.axis||0;m=m>-1?m:g.length+m;for(var y=[],b=[],w=f.slice(0,4),_=void 0,A=0;A<d;A++){var x=0===A?w:f.slice(3*A+1,3*(A+1)+1),k=L(x,g,m,i);0!==A&&x.splice(0,0,_.name),k.shape[m]+=_?_.shape[m]:0;var O={Out:[k.name]};b.push({attrs:h,inputs:{X:x},outputs:O,type:\"concat\"}),y.push(k),_=k}b[d-1].outputs.Out=[v],n.splice.apply(n,C([s,1],b)),u(i,y)}}},e}(k);var W=function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),i=0;for(e=0;e<r;e++)for(var s=arguments[e],a=0,o=s.length;a<o;a++,i++)n[i]=s[a];return n};function H(t){if(t.length<4){for(var e=[],r=0;r<4-t.length;r++)e.push(1);return e.concat(t)}return W(t)}function B(t){return t.reduce((function(t,e){return t+e}))}function G(t,e){var r=t.length;return 4-r+(e>-1?e:r+e)}function z(t,e){for(var r=e[0],n=e[1],i=e[2],s=e[3],a=i*s,o=n*i*s,u=[],h=0;h<r;h++)for(var c=0;c<s;c++)for(var p=0;p<n;p++)for(var f=0;f<i;f++)u.push(t[h*o+p*a+f*s+c]);return new Float32Array(u)}function X(t){for(var e,r=t.data,n=t.shape,i=W(n).reverse(),s=0,a=i.length-1;s<a;s++)e=V(e||r,i[s]);return e}function V(t,e){for(var r=[],n=0,i=t.length;n<i;n+=e)r.push(t.slice(n,n+e));return r}var U=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Y=\"fetch_pack\";const q=function(t){function e(){return t.call(this,\"PackOut\")||this}return U(e,t),e.prototype.transform=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(p.get(\"webgl_pack_output\")&&1!==p.get(\"webglVersion\")){var r=t[0],n=t[1],i=r.find((function(t){return\"fetch\"===t.type})),s=i.inputs.X[0],a=o(n,s),h=H(a.shape),c=h[0],f=h[1],l=h[2],d=h[3],v={attrs:{},inputs:{X:[s]},outputs:{Y:[Y]},type:\"pack_out\"},g=f*d,m=Math.ceil(c*l/4),y={name:Y,shape:[1,1,m,g],persistable:!1};i.inputs.X=[Y],i.attrs.origin_shape=[c,f,l,d],r.push(v),u(n,[y])}},e}(k);var J=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),K=\"img_pre_processed\",Z=\"img_origin\";const $=function(t){function e(){return t.call(this,\"FeedProcess\")||this}return J(e,t),e.prototype.transform=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t[0],n=t[1],i=t[2];if(i.webglFeedProcess||p.get(\"webgl_gpu_pipeline\")){var s=i.mean,a=void 0===s?[0,0,0]:s,h=i.std,c=void 0===h?[1,1,1]:h,f=i.scale,l=void 0===f?[1,1]:f,d=i.pos,v=void 0===d?[0,0]:d,g=i.feedShape,y=o(n,\"image\"),b=y.shape,w=b[2],_=b[3];y.shape=[1,1,w,_];var A=Object.assign({},y);A.name=K,A.shape=[1,3,g.fh,g.fw],A.persistable=!1,delete A.data;var x=Object.assign({},y);x.name=Z,x.shape=[1,1,g.fh,g.fw],x.persistable=!1,delete x.data,u(n,[x,A]);var k=r.find((function(t){var e=t.inputs;return Object.keys(e).find((function(t){return\"image\"===e[t][0]}))})),O=k.inputs;Object.keys(O).forEach((function(t){\"image\"===O[t][0]&&(O[t][0]=K)}));var P={attrs:{mean:a,std:c},inputs:{X:[Z]},outputs:{Y:[K]},type:\"feedPost\"},T={attrs:{mean:a,std:c,scale:l,pos:v},inputs:{X:[\"image\"]},outputs:{Y:[Z]},type:\"imgFeed\",uniform:{u_scale:{type:m.uniform2fv,value:[1,1]},u_pos:{type:m.uniform2fv,value:[0,0]},u_keep_ratio:{type:m.uniform1i,value:1}},isPacked:!0};r.splice(1,0,P),r.splice(1,0,T)}},e}(k),Q={preTransforms:[new R,new q,new $],transforms:[new N,new F],postTransforms:[]};var tt,et=function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),i=0;for(e=0;e<r;e++)for(var s=arguments[e],a=0,o=s.length;a<o;a++,i++)n[i]=s[a];return n};function rt(t,e){return t&&t[e]||[]}!function(t){t.PreTransforms=\"preTransforms\",t.Transforms=\"transforms\",t.PostTransforms=\"postTransforms\"}(tt||(tt={}));const nt=function(){function t(t,e){this.weightMap=[],this.ops=[],this.vars=[],this.config={},this.type=y.SingleOutput,this.plugins=null,this.ops=t.ops,this.vars=t.vars,this.type=e.type||this.type,this.plugins=e.plugins,this.config=e,t.feedShape&&(this.config.feedShape=t.feedShape)}return t.prototype.createGraph=function(){return this.preTransforms(),this.createOpsMap(),this.arrangeMap(),this.postTransforms(),this.weightMap},t.prototype.preTransforms=function(){var t=this;et(Q.preTransforms,rt(this.plugins,tt.PreTransforms)).forEach((function(e){e.transform(t.ops,t.vars,t.config)}))},t.prototype.transforms=function(t,e){var r=this;et(Q.transforms,rt(this.plugins,tt.Transforms)).forEach((function(n){n.transform(t,r.vars,e)}))},t.prototype.postTransforms=function(){var t=this;et(Q.postTransforms,rt(this.plugins,tt.PostTransforms)).forEach((function(e){e.transform(t.weightMap,t.vars,t.type)}))},t.prototype.createOpsMap=function(){for(var t=[],e=0;e<this.ops.length;e++){var r=t.length,n=this.ops[e],i=new x(n,r);this.transforms(i,t),t.push(i)}this.weightMap=t},t.prototype.arrangeMap=function(){for(var t={},e=[],r={},n=function(n){for(var s=i.weightMap[n],a=0;a<s.outputsName.length;a++){var o=s.outputsName[a];t[o]=!0}e[n]=0,r[s.id]=n,s.inputsName.length>1?s.inputsName.forEach((function(r){!0===t[r]&&e[n]++})):e[n]=s.inputsName.length},i=this,s=0;s<this.weightMap.length;s++)n(s);this.topoSort(this.weightMap,e,r)},t.prototype.topoSort=function(t,e,r){var n=[];n.push(t[0]);for(var i=t.slice(0),s=null,a=t[0];n.length>0;){null!=s&&(t[r[s.id]].next=a.id),s=a,a=n.pop()||{};for(var o=0;o<a.outputsName.length;o++)for(var u=0;u<i.length;u++)for(var h=0;h<i[u].inputsName.length;h++)if(i[u].inputsName[h]===a.outputsName[o]&&(e[r[i[u].id]]--,0===e[r[i[u].id]])){n.push(t[r[i[u].id]]),i.splice(u,1),u--;break}}},t.prototype.getFeedExecutor=function(){return this.weightMap.find((function(t){return\"feed\"===t.type}))},t.prototype.getFetchExecutor=function(){return this.weightMap.find((function(t){return\"fetch\"===t.type}))},t.prototype.getExecutorById=function(t){return this.weightMap.find((function(e){return e.id===t}))},t}(),it=function(){function t(t){this.opts={},this.isPacked=!1,this.name=\"\",this.tensorId=\"\",this.total=1,this.shape=[],this.unformattedShapeLength=0,this.shape_texture=[],this.exceedMax=!1,this.data=null,this.persistable=!1,this.interpType=\"NEAREST\",this.dataLayout=\"\",this.runtime=0,this.binding=0;var e=t.isPacked,r=void 0!==e&&e,n=t.name,i=t.runtime,s=void 0===i?0:i,a=t.persistable,o=void 0!==a&&a,u=t.type,h=t.dataLayout,c=t.interpType,p=void 0===c?\"NEAREST\":c,f=t.shape,l=t.data,d=t.binding,v=void 0===d?0:d;this.opts=t,this.isPacked=r,this.name=n,this.runtime=s,this.binding=v,this.persistable=o,this.interpType=p,this.tensorId=u,this.dataLayout=h,this.unformattedShapeLength=f.length,this.shape=H(f),this.total=this.shape.reduce((function(t,e){return t*e})),t.noLayout||l&&l.length&&(this.data=function(t,e,r,n){if(\"nhwc\"===e){var i=r[0],s=r[1],a=z(t,[i,r[2],r[3],s*(n?4:1)]);return new Float32Array(a)}return new Float32Array(t)}(l,this.dataLayout,this.shape,this.isPacked),t.data=null)}return Object.defineProperty(t.prototype,\"width_texture\",{get:function(){var t=this.shape_texture.length;return this.shape_texture[t-1]||1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,\"height_texture\",{get:function(){var t=this.shape_texture.length;return this.shape_texture[t-2]||1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,\"width_shape\",{get:function(){var t=this.shape.length;return this.shape[t-1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,\"height_shape\",{get:function(){var t=this.shape.length;return this.shape[t-2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,\"channel\",{get:function(){var t=this.shape.length;return this.shape[t-3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,\"length_shape\",{get:function(){return this.shape.length||0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,\"length_unformatted_shape\",{get:function(){return this.unformattedShapeLength||0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,\"total_shape\",{get:function(){return this.total},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,\"numbers_shape\",{get:function(){for(var t=[],e=this.shape.length,r=0;r<e-1;r++){var n=this.shape.slice(r+1).reduce((function(t,e){return t*e}));t.push(n)}return t.push(1),t},enumerable:!1,configurable:!0}),t}(),st={adaptPaddings:function(){for(var t in this.processedAttrs)if(Object.prototype.hasOwnProperty.call(this.processedAttrs,t)&&\"paddings\"===t){var e=this.processedAttrs[t],r=e[0],n=e[1];return void(0===r&&1===n&&(this.processedAttrs[t][1]=0))}},setAdaptive:function(){this.processedAttrs.adaptive&&2===this.processedAttrs.ksize.length&&1===this.processedAttrs.ksize[0]&&1===this.processedAttrs.ksize[1]&&(this.processedAttrs.adaptive=!1,this.processedAttrs.global_pooling=!0)},isGlobalPooling:function(){var t,e=this.tensorDataMap.origin,r=(null===(t=null==e?void 0:e.shape)||void 0===t?void 0:t.length)||0;r>2&&this.processedAttrs.global_pooling&&(this.processedAttrs.ksize=[e.shape[r-2],e.shape[r-1]])},setPacked:function(){var t=this.processedAttrs.ispacked;this.tensorDataMap.origin&&t&&this.name.indexOf(\"pool\")>-1&&(this.name+=\"_winograd\")},mergeAttrs:function(){this.processedAttrs=this.subAttrs.reduce((function(t,e){return Object.assign(t,e)}),{})},isApplySeparableConv:function(){if(!this.isPackedOp){var t=this.processedAttrs.groups,e=this.tensorDataMap.filter;if(\"depthwise_conv2d\"===this.name&&(this.name=\"conv2d\"),e){var r=e.shape,n=r[0],i=r[1];n===t&&1===i&&(this.name+=\"_depthwise\")}}},batchComputeConv2d:function(){var t=this.tensorDataMap.filter.shape[1];this.processedAttrs.filter_nearest_vec4=4*Math.floor(t/4),this.processedAttrs.filter_remainder_vec4=t%4},processBias:function(){var t=this.tensorDataMap.bias;if(t&&this.isPackedOp){t.packed=!0;var e=t.shape,r=[e[e.length-1]/4,1,1];t.shape=r}},isMax:function(){var t=\"max\"===this.processedAttrs.pooling_type?1:0;this.processedAttrs.pooling_type=t,1===t&&(this.name+=\"_max\")},transToPrelu:function(){this.processedAttrs.multi_value=\"0.0\",this.processedAttrs.active_function=\"prelu\"},transToRelu6:function(){this.processedAttrs.multi_value=this.processedAttrs.threshold,this.processedAttrs.active_function=\"relu6\"},transToHardSigmoid:function(){this.processedAttrs.multi_value=this.processedAttrs.slope||.2,this.processedAttrs.bias_value=this.processedAttrs.offset||.5,this.processedAttrs.active_function=\"hardSigmoid\"},transToLeakyrelu:function(){this.processedAttrs.multi_value=this.processedAttrs.alpha,this.processedAttrs.active_function=\"leakyRelu\",this.name=\"relu\"},transToPow:function(){this.processedAttrs.multi_value=this.processedAttrs.factor||2,this.processedAttrs.active_function=\"pow_func\",this.name=\"pow\"},transToSigmoid:function(){this.processedAttrs.active_function=\"sigmoid\"},transToSqrt:function(){this.processedAttrs.active_function=\"sqrt\"},transToTanh:function(){this.processedAttrs.active_function=\"tanh_func\"},transToExp:function(){this.processedAttrs.active_function=\"exp\"},transToScale:function(){var t=this.processedAttrs.scale;this.processedAttrs.multi_value=void 0!==t?t:1,this.processedAttrs.bias_value=this.processedAttrs.bias||0;var e=this.processedAttrs.bias_after_scale;this.processedAttrs.active_function=e||void 0===e?\"scale\":\"scaleWidthBias\"},setActiveFunc:function(){var t=this.name.replace(\"conv2d-elementwise_add-\",\"\");this.processedAttrs=Object.assign({active_function:\"scale\",multi_value:\"1.0\",bias_value:\"0.0\",fuse_relu:!1},this.processedAttrs),\"leaky_relu\"===t&&(this.processedAttrs.multi_value=this.processedAttrs.alpha,this.processedAttrs.active_function=\"leakyRelu\")},normalizePerm:function(){var t=this.tensorDataMap.origin.shape.length,e=this.processedAttrs.axis,r=e.length;if(r-t>0&&(r=(e=e.map((function(t){return t-1})).filter((function(t){return t>=0}))).length),r>4)throw Error(\"op transpoes2 axis length exceeds maximum length 4, get \"+r);for(var n=new Array(r).fill(0),i=0;i<r;i++)n[e[i]]=i;var s=[];for(i=0;i<4;i++)s[i]=n[i]||0;this.processedAttrs.perm_arr=s,this.processedAttrs.perm_size=r},normalizeDim:function(){for(var t=this.tensorDataMap.origin.shape,e=H(t),r=G(t,this.processedAttrs.axis),n=[],i=0;i<e[r];i++)n[i]=i;if(this.processedAttrs.target_length=n.length,this.processedAttrs.target_value=n,this.processedAttrs.inputs_dim=e[r],this.processedAttrs.dim=r,0===this.processedAttrs.num&&(this.processedAttrs.num=Object.values(this.tensorDataMap).filter((function(t){return\"out\"===t.tensorName})).length||1),\"wasm\"===p.get(\"backend\")){this.processedAttrs.fourInputs=!1;var s=this.tensorDataMap.counter;if(s){var a=H(s.shape);this.processedAttrs.counter_num=a[r]}var o=this.tensorDataMap.appender;if(o){var u=H(o.shape);this.processedAttrs.append_num=u[r]}var h=this.tensorDataMap.fourth;if(h){this.processedAttrs.fourInputs=!0;var c=H(h.shape);this.processedAttrs.fourth_num=c[r]}}},processElementwiseAxis:function(){var t=this.tensorDataMap.origin.shape,e=this.tensorDataMap.counter.shape,r=this.processedAttrs.axis||-1;this.processedAttrs.counterLen=e.length,B(t)===B(e)?(this.processedAttrs.axis=0,this.processedAttrs.counterLen=4):(-1===r&&(r=t.length-e.length),this.processedAttrs.axis=G(t,r))},genElementwiseCounterPos:function(){for(var t=this.processedAttrs,e=t.counterLen,r=[\"0\",\"0\",\"0\",\"0\"],n=t.axis,i=4-e;i<4;i++)r[i]=\"oPos[\"+n+++\"]\";this.processedAttrs.counterPos=r.join(\",\")},flattenShape:function(){var t=Object.values(this.tensorDataMap).find((function(t){return t.shape.length>2}));if(t){var e=H(t.shape);t.shape=[e[0]*e[2],e[1]*e[3]]}},reshape:function(){var t=this.tensorDataMap.origin,e=this.tensorDataMap.counter,r=this.tensorDataMap.out;if(e.shape.length>t.shape.length){var n=e;e=t,t=n}if(t.shape.length>2&&2===e.shape.length){var i=function(t,e){void 0===t&&(t=[]),void 0===e&&(e=[]);var r=t.reduce((function(t,e){return t*e}));return 1===e.length?[1,r]:[e[0],r/e[0]]}(t.shape,r.shape);t.shape=i}},checkIsMerge:function(){var t=this.name.replace(\"conv2d-elementwise_add-\",\"\");this.name=\"conv2d_elementwise_add\",\"leaky_relu\"===t&&(this.processedAttrs.alpha&&(this.processedAttrs.multi_value=this.processedAttrs.alpha),this.processedAttrs.active_function=\"leakyRelu\")}};var at=function(){return(at=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};const ot=function(){function t(t,e,r,n,i){this.name=\"\",this.isPackedOp=!1,this.processedAttrs={},this.subAttrs=[],this.uniform=null,this.inputTensors=[],this.outputTensors=[],this.dataLayout=\"\",this.iLayer=0,this.program=[],this.isFinalOp=!1,this.bufferType=v.FrameBuffer,this.tensorDataMap={},this.tensorData=[];var s=t.type,a=t.inputs,o=t.outputs,u=t.attrs,h=t.isPacked,c=t.bufferType,p=void 0===c?v.FrameBuffer:c,f=t.uniform,l=void 0===f?null:f;this.modelName=i,this.subAttrs=t.subAttrs,this.name=s,this.isPackedOp=h,this.bufferType=p,this.dataLayout=r.dataLayout||\"\",this.iLayer=e,this.isFinalOp=n,this.uniform=l,this.initExtendedAttrs(u),this.constructTensorData(a,o,r.vars),this.buildTensor();var d=this.buildShaderParams();this.buildProgram(d)}return t.prototype.initExtendedAttrs=function(t){for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)){var r=t[e];this.processedAttrs[e]=r}},t.prototype.constructTensorData=function(t,e,r){var n=this;Object.keys(e).forEach((function(t){e[t].forEach((function(i,s){e[t][s]=n.getTensorVar(i,r)}))})),Object.keys(t).forEach((function(e){t[e]=[n.getTensorVar(t[e][0],r)]}));var i=function(t){if(Object.prototype.hasOwnProperty.call(e,t))try{var r=e[t]||[{}],i=s.getExactTensorName(t,\"output\");i&&r.forEach((function(t,e){t.tensorName=i,n.tensorDataMap[i+\"_\"+e]=at(at({},t),{tensorName:i,runtime:e})}))}catch(t){console.error(t)}},s=this;for(var a in e)i(a);for(var a in t)if(Object.prototype.hasOwnProperty.call(t,a)){var o=t[a].length>0?t[a]:[{}],u=this.getExactTensorName(a,\"input\");if(u){var h=o[0];h.tensorName=u,this.tensorDataMap[u]=at(at({},h),{tensorName:u})}}},t.prototype.getExactTensorName=function(t,e){return\"input\"===e?{input:\"origin\",x:\"origin\",y:\"counter\",w:\"weight\"}[t.toLowerCase()]||t.toLowerCase():{output:\"out\",y:\"out\",out:\"out\",scale:\"scale\",bias:\"bias\",mean:\"mean\",variance:\"variance\",mask:\"out\",boxes:\"out\",variances:\"out\"}[t.toLowerCase()]},t.prototype.getTensorVar=function(t,e){var r=o(e,t.replace(/_packed$/,\"\"));return r&&t.endsWith(\"_packed\")?function(t,e){var r=3===t.shape.length?W([1],t.shape):t.shape,n=r[0],i=r[1],s=r[2],a=r[3],o=Object.assign({},t);if(o.name=e,o.packed=!1,i%4==0){var u=i/4;o.packed=!0,o.shape=[n,u,s,a]}return o}(r,t):r},t.prototype.buildProgram=function(t){var e=this,r=this.name,n=b.backend+\"_\"+r,i=b.opRegistry.ops[n];try{if(!i&&\"wasm\"!==p.get(\"backend\"))throw new Error(\"[unregistered op] \"+r);var s=this.inputTensors;this.program=this.outputTensors.map((function(r,n){return b.backendInstance.createProgram({op:i,outTensor:r,inputTensors:s,shaderParams:t[n],runtime:n,isFinalOp:e.isFinalOp})}))}catch(t){console.error(t)}},t.prototype.processTensorDataAndAttrs=function(){var t=this;try{this.name.indexOf(\"conv2d-elementwise_add\")>-1?this.name=\"conv2d_elementwise_add\":this.name.indexOf(\"max_pool2d_with_index\")>-1&&(this.name=\"pool2d_max\");var e=b.backend+\"_\"+this.name;(b.opRegistry.ops[e]&&b.opRegistry.ops[e].behaviors||[]).forEach((function(e){try{st[e].call(t)}catch(t){console.error(t)}}))}catch(t){console.error(t)}},t.prototype.buildTensor=function(){var t=this;this.processTensorDataAndAttrs();var e=Object.values(this.tensorDataMap);e.forEach((function(e,r){var n,i=e.tensorName,s=new it({type:t.modelName+\"_\"+e.name,name:i,shape:e.shape,data:e.data||null,persistable:e.persistable||!1,interpType:e.interpType||\"NEAREST\",isPacked:t.isPackedOp||e.packed||!1,binding:r,noLayout:null===(n=b.backendInstance)||void 0===n?void 0:n.noLayout,dataLayout:t.dataLayout,runtime:e.runtime||0});\"out\"===i?t.outputTensors.push(s):t.inputTensors.push(s),e.shape=s.shape,e.total=s.total})),this.tensorDataMap=null,this.tensorData=e},t.prototype.buildShaderParams=function(){var t=this,e=[];return this.outputTensors.forEach((function(){var r=JSON.parse(JSON.stringify(t.processedAttrs));e.push(r)})),e},t}();var ut=function(){return(ut=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};const ht=function(){function t(){this.targetContext={},this.gapFillWith=\"#fff\",this.mean=[0,0,0],this.std=[1,1,1],this.bgr=!1,this.pixelWidth=1,this.pixelHeight=1,this.inputFeed=[],this.targetCanvas=p.get(\"canvas2d\")||document.createElement(\"canvas\"),this.targetContext=this.targetCanvas.getContext(\"2d\")}return t.prototype.process=function(t,e,r){var n=e.fill,i=e.mean,s=e.std,a=e.bgr,o=e.keepRatio,u=void 0===o||o,h=e.scale,c=void 0===h?0:h,p=r.fc,f=void 0===p?3:p,l=r.fh,d=r.fw,v=t,g={gapFillWith:n||this.gapFillWith,mean:i||this.mean,std:s||this.std,bgr:a||this.bgr,keepRatio:u,scale:c,targetSize:{width:d,height:l},targetShape:[1,f,l,d]};return this.fromPixels(v,g)||[]},t.prototype.fromPixels=function(t,e){var r=[],n={gapFillWith:e.gapFillWith,dx:0,dy:0,dWidth:e.targetSize.width,dHeight:e.targetSize.height},i=t,s=t.path&&t.width&&t.height;if(!s&&!(t instanceof ImageBitmap||t instanceof HTMLVideoElement||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement))return[{data:r,shape:e.shape||e.targetShape,name:\"image\",persistable:!0}];this.pixelWidth=t.naturalWidth||t.width,this.pixelHeight=t.naturalHeight||t.height;var a=p.get(\"webgl_gpu_pipeline\")||e.webglFeedProcess;return this.fitToTargetSize(s?i.path:i,n,ut(ut({},e),{inGPU:a})),r=this.getImageData(n),a?[{data:r=Float32Array.from(r.data),shape:[1,1,n.dHeight,n.dWidth],name:\"image\",persistable:!0}]:[{data:r=this.allReshapeToRGB(r,e),shape:e.targetShape||e.shape,name:\"image\",persistable:!0}]},t.prototype.allReshapeToRGB=function(t,e){for(var r=e.mean,n=e.std,i=e.targetShape,s=e.bgr,a=e.normalizeType,o=void 0===a?0:a,u=i[1],h=i[2],c=i[3],p=t.data||t,f=new Float32Array(h*c*u),l=0,d=0;d<h;++d)for(var v=d*c,g=0;g<c;++g)for(var m=v+g,y=0;y<u;++y){var b=s?4*m+(2-y):4*m+y;f[l]=0===o?p[b]/255:(p[b]-128)/128,f[l]-=r[y],f[l]/=n[y],l++}return z(f,[1,h,c,u])},t.prototype.fitToTargetSize=function(t,e,r){var n=r||{},i=n.keepRatio,s=void 0===i||i,a=n.inGPU,o=void 0!==a&&a,u=n.scale,h=void 0===u?0:u,c=e.dWidth,p=e.dHeight,f=o?this.pixelWidth:c,l=o?this.pixelHeight:p,d=o?this.pixelWidth:c,v=o?this.pixelHeight:p,g=0,m=0;if(h){if(d-c<0||v-p<0)throw new Error(\"scale size smaller than target size\");this.pixelWidth>this.pixelHeight?(v=h,d=Math.round(v*this.pixelWidth/this.pixelHeight)):(d=h,v=Math.round(d*this.pixelHeight/this.pixelWidth)),this.targetCanvas.width=f=d,this.targetCanvas.height=l=v,e.dx=(d-c)/2,e.dy=(v-p)/2}else s&&(c/p*this.pixelHeight/this.pixelWidth>=1?o?(f=Math.round(v*c/p),g=Math.floor((f-d)/2)):(d=Math.round(v*this.pixelWidth/this.pixelHeight),g=Math.floor((c-d)/2)):o?(l=Math.round(d*p/c),m=Math.floor((l-v)/2)):(v=Math.round(d*this.pixelHeight/this.pixelWidth),m=Math.floor((p-v)/2))),this.targetCanvas.width=e.dWidth=f,this.targetCanvas.height=e.dHeight=l;this.targetContext.fillStyle=e.gapFillWith,this.targetContext.fillRect(0,0,this.targetCanvas.width,this.targetCanvas.height),this.targetContext.drawImage(t,g,m,d,v)},t.prototype.getImageData=function(t){var e=t.dx,r=t.dy,n=t.dWidth,i=t.dHeight;return this.targetContext.getImageData(e,r,n,i)},t.prototype.cover=function(t,e,r,n){var i=r,s=n;return r/n*e/t>=1?i=Math.round(s*t/e):s=Math.round(i*e/t),[i/r,s/n]},t}();var ct=function(){return(ct=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function pt(t,e,r){for(var n=[],i=0,s=t.length;i<s;i++){var a=t[i];a>e&&n.push({score:a,i})}return n.sort((function(t,e){return e.score-t.score})).slice(0,r)}function ft(t){var e=t[0],r=t[1],n=t[2],i=t[3];return n<e||i<r?0:(n-e)*(i-r)}function lt(t,e){if(e[0]>t[2]||e[2]<t[0]||e[1]>t[3]||e[3]<t[1])return 0;var r=ft(t),n=ft(e),i=function(t,e){var r=t[0],n=t[1],i=t[2],s=t[3],a=e[0],o=e[1],u=e[2],h=e[3],c=Math.max(r,a),p=Math.max(n,o);return(Math.min(i,u)-c)*(Math.min(s,h)-p)}(t,e);return i/(r+n-i)}const dt={multiclass_nms:function(t,e){var r=t[0],n=void 0===r?[]:r,i=t[1],s=void 0===i?[]:i,a=X(n),o=X(s);if(!a||!o)return[];if(a=a[0],o=o[0],!(a&&a.length&&o&&o.length))return[];for(var u=e.nms_top_k,h=void 0===u?100:u,c=e.nms_eta,p=void 0===c?1:c,f=e.keep_top_k,l=void 0===f?100:f,d=e.background_label,v=void 0===d?0:d,g=e.nms_threshold,m=void 0===g?.3:g,y=e.score_threshold,b=void 0===y?0:y,w=[],_=0,A=o.length;_<A;_++){var x=[];if(_!==v){var k=pt(o[_],b,h);if(!k||!k.length)return[];var O=k.shift(),P=a[O.i];for(x.push(ct(ct({},O),{box:P,label:_}));k.length;){var T=k.shift();P=a[T.i];for(var M=!0,j=0,E=x;j<E.length;j++)if(lt(P,E[j].box)>m){M=!1;break}M&&x.push(ct(ct({},T),{box:P,label:_})),M&&p<1&&m>.5&&(m*=p)}w=w.concat(x)}}var F=w.sort((function(t,e){return e.score-t.score})).slice(0,l).sort((function(t,e){return t.label-e.label})).map((function(t){return function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),i=0;for(e=0;e<r;e++)for(var s=arguments[e],a=0,o=s.length;a<o;a++,i++)n[i]=s[a];return n}([t.label,t.score],t.box)}));return F&&F.length?F:[]}};var vt=function(t,e,r,n){return new(r||(r=Promise))((function(i,s){function a(t){try{u(n.next(t))}catch(t){s(t)}}function o(t){try{u(n.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,o)}u((n=n.apply(t,e||[])).next())}))},gt=function(t,e){var r,n,i,s,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},\"function\"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(s){return function(o){return function(s){if(r)throw new TypeError(\"Generator is already executing.\");for(;a;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((i=(i=a.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){a.label=s[1];break}if(6===s[0]&&a.label<i[1]){a.label=i[1],i=s;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(s);break}i[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,o])}}};const mt=function(){function t(t){this.runnerConfig={},this.isPaused=!1,this.model={},this.weightMap=[],this.isExecuted=!1,this.test=!1,this.graphGenerator={},this.mediaProcessor=null,this.needPreheat=!0,this.feedShape={},this.runnerConfig=Object.assign({},t),this.needPreheat=void 0===t.needPreheat||t.needPreheat,this.modelName=t.modelName||Date.now().toString(),this.weightMap=[],p.set(\"ns\",s()),\"node\"!==p.get(\"platform\")&&(this.mediaProcessor=new ht)}return t.prototype.init=function(){return vt(this,void 0,void 0,(function(){var t;return gt(this,(function(e){switch(e.label){case 0:return b.backendInstance?(this.isExecuted=!1,\"wasm\"!==p.get(\"backend\")?[3,2]:[4,Promise.all([this.load(),b.backendInstance.init()])]):(console.error(\"ERROR: Haven't register backend\"),[2]);case 1:return e.sent(),[3,4];case 2:return b.backendInstance.init(),this.isExecuted=!1,[4,this.load()];case 3:e.sent(),e.label=4;case 4:return this.genFeedData(),this.genGraph(),this.genOpData(),\"wasm\"!==p.get(\"backend\")?[3,6]:(this.model=Object.assign(this.model,this.runnerConfig),t=this.model,[4,b.backendInstance.initWasm(this.model,this.weightMap)]);case 5:return t.index=e.sent(),[2,[]];case 6:return this.needPreheat?[4,this.preheat()]:[3,8];case 7:return[2,e.sent()];case 8:return[2]}}))}))},t.prototype.load=function(){return vt(this,void 0,void 0,(function(){var t,e,r,n,i,s,a,o;return gt(this,(function(u){switch(u.label){case 0:return t=this.runnerConfig,e=t.modelPath,r=t.modelObj,n=void 0===r?null:r,e?(i=new d(e),s=this,[4,i.load()]):[3,2];case 1:return s.model=u.sent(),[3,3];case 2:(null==n?void 0:n.model)&&(null==n?void 0:n.params)&&(a=n.model,o=n.params,d.allocateParamsVar(a.vars,o),this.model=a),u.label=3;case 3:return[2]}}))}))},t.prototype.genGraph=function(){this.graphGenerator=new nt(this.model,this.runnerConfig),this.weightMap=this.graphGenerator.createGraph()},t.prototype.genOpData=function(){var t=this,e=0;this.weightMap.forEach((function(r,n){var i=r.type;if(\"feed\"!==i&&\"fetch\"!==i){e++;var s=n===t.weightMap.length-2,a=new ot(r,e,t.model,s,t.modelName);r.opData=a}})),c(this.model)},t.prototype.preheat=function(){return vt(this,void 0,void 0,(function(){var t;return gt(this,(function(e){switch(e.label){case 0:return[4,this.checkModelLoaded()];case 1:return e.sent(),[4,this.execute()];case 2:return t=e.sent(),this.isExecuted=!0,[2,t]}}))}))},t.prototype.checkModelLoaded=function(){return vt(this,void 0,void 0,(function(){return gt(this,(function(t){switch(t.label){case 0:return 0!==this.weightMap.length?[3,2]:(console.info(\"It's better to preheat the model before running.\"),[4,this.load()]);case 1:t.sent(),this.genFeedData(),this.genGraph(),this.genOpData(),this.isExecuted=!1,t.label=2;case 2:return[2]}}))}))},t.prototype.predict=function(t,e){return vt(this,void 0,void 0,(function(){var r,n,i;return gt(this,(function(s){switch(s.label){case 0:return this.isPaused||!this.mediaProcessor?[2]:(r=[],r=this.runnerConfig.webglFeedProcess?[t]:this.mediaProcessor.process(t,this.runnerConfig,this.feedShape),n=[],\"wasm\"!==p.get(\"backend\")?[3,3]:[4,b.backendInstance.predict(r[0].data,this.model.index)]);case 1:return s.sent(),[4,this.read()];case 2:return i=s.sent(),n=this.postProcess(i),[3,5];case 3:return this.updateFeedData(r),[4,this.execute()];case 4:n=s.sent(),s.label=5;case 5:return this.isExecuted=!0,[2,e?e(n):n]}}))}))},t.prototype.predictWithFeed=function(t,e,r){var n;return vt(this,void 0,void 0,(function(){var i,s,a,o,u,h,c,f,l,d,v,g;return gt(this,(function(m){switch(m.label){case 0:return i=this.feedShape,s=i.fc,a=void 0===s?3:s,o=i.fw,u=i.fh,Array.isArray(t)?(null===(n=t[0])||void 0===n?void 0:n.data)?((d=t[0].data)instanceof Float32Array||(t[0].data=new Float32Array(d)),h=t):h=[{data:new Float32Array(t),shape:r||[1,a,u,o],name:\"image\",persistable:!0}]:(f=(c=t).width,l=c.height,d=c.data,h=[{data:new Float32Array(d),shape:r||[1,a,l||u,f||o],name:\"image\",persistable:!0}]),v=[],\"wasm\"!==p.get(\"backend\")?[3,3]:[4,b.backendInstance.predict(h[0].data,this.model.index)];case 1:return m.sent(),[4,this.read()];case 2:return g=m.sent(),v=this.postProcess(g),[3,5];case 3:return this.updateFeedData(h),[4,this.execute()];case 4:v=m.sent(),m.label=5;case 5:return this.isExecuted=!0,[2,e?e(v):v]}}))}))},t.prototype.genFeedData=function(){var t,e=this.runnerConfig,r=e.type,n=e.feedShape,i=e.webglFeedProcess;this.feedShape=this.model.feedShape||n;var s,a=this.feedShape,h=a.fc,c=void 0===h?3:h,f=a.fh,l=a.fw,d=this.model.vars;if(r===y.MultipleInput){var v=this.model.ops&&this.model.ops[0]&&(null===(t=this.model.ops[0].inputs)||void 0===t?void 0:t.X);v.length>1&&(s=v.map((function(t){var e=o(d,t),r=e.shape.reverse(),n=r[0],i=r[1],s=r[2],a=r[3],u=void 0===a?1:a;return e.data=new Float32Array(u*s*i*n),e})))}else{var g=\"wasm\"!==p.get(\"backend\")&&i?4:c;s=o(d,\"image\");var m={name:\"image\",shape:[1,g,f,l]};s=Object.assign(m,s,{data:new Float32Array(g*f*l).fill(1),persistable:!0})}u(d,s)},t.prototype.updateFeedData=function(t){var e=t[0],r=this.weightMap.find((function(t){return t.opData?t.opData.inputTensors.find((function(t){return t.tensorId.endsWith(\"_image\")})):null})),n=r.opData.inputTensors.find((function(t){return t.tensorId.endsWith(\"_image\")}));n.data=e.data;var i=this.runnerConfig,s=i.webglFeedProcess,a=void 0!==s&&s,o=i.keepRatio,u=void 0===o||o;if(a||p.get(\"webgl_gpu_pipeline\")){var h=e.shape||[1,1,e.height,e.width],c=new Uint8Array(e.data||[]);if(e.width&&e.height&&!e.data){var f=e.naturalWidth||e.width;h=[1,1,e.naturalHeight||e.height,f],c=e}var l=n.opts;l.shape=h;var d=r.opData,v=new it(l);v.data=c,d.inputTensors=[v];var g=h.slice(-2),m=g[0],y=g[1],b=d.outputTensors[0].shape.slice(-2),w=b[0],_=b[1],A=this.mediaProcessor.cover(y,m,_,w);r.uniform.u_scale.value=A,r.uniform.u_keep_ratio.value=+u}},t.prototype.execute=function(){return vt(this,void 0,void 0,(function(){var t,e;return gt(this,(function(r){switch(r.label){case 0:return t=this.graphGenerator.getFeedExecutor(),this.executeOp(t),[4,this.read()];case 1:return e=r.sent(),[2,this.postProcess(e)]}}))}))},t.prototype.postProcess=function(t){var e=\"wasm\"===p.get(\"backend\");if(p.get(\"debug\"))return t;var r=t,n=this.model,i=n.multiOutputs,s=n.postOps;if(i)if(e)r=i.map((function(e,r){var n;return(n={})[e.name]=t[r],n}));else{var a=0;r=i.map((function(e){var r,n=e.shape.reduce((function(t,e){return t*e})),i=t.slice(a,n+a);return a+=n,(r={})[e.name]=i,r}))}if(i&&s&&s.length)for(var o=function(t,e){var n=s[t],i=n.type,a=n.attrs,o=n.inputs,u=dt[i];if(!u)return{value:void 0};var h=function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),i=0;for(e=0;e<r;e++)for(var s=arguments[e],a=0,o=s.length;a<o;a++,i++)n[i]=s[a];return n}(r),c=Object.keys(o).map((function(t){var e=o[t],r=e.name,n=e.shape,i=h.filter((function(t){return t[r]}));return i&&i[0]&&i[0][r]?{name:t,tensorId:r,data:i[0][r],shape:n}:(console.error(\"未获取到\"+r+\"的数据\"),null)}));r=u(c,a)},u=0,h=s.length;u<h;u++){var c=o(u);if(\"object\"==typeof c)return c.value}return r},t.prototype.executeOp=function(t){var e;if(\"fetch\"!==t.type)if(\"feed\"!==t.type&&t.execute(this.isExecuted),p.get(\"debug\")&&(null===(e=t.opData)||void 0===e?void 0:e.outputTensors)&&t.opData.outputTensors[t.opData.outputTensors.length-1]&&t.opData.outputTensors[t.opData.outputTensors.length-1].tensorId===this.modelName+\"_\"+(p.get(\"ns\").layerName||p.get(\"layerName\")))console.info(t.opData.name+\"_\"+t.opData.iLayer,\"runner op\");else if(t.next){var r=t.next,n=this.graphGenerator.getExecutorById(r);this.executeOp(n)}},t.prototype.read=function(){return vt(this,void 0,void 0,(function(){var t,e,r;return gt(this,(function(n){switch(n.label){case 0:return t=this.graphGenerator.getFetchExecutor(),e=o(this.model.vars,t.inputs.X[0]),r={name:e.name,shape:t.attrs.origin_shape||e.shape,index:this.model.index},[4,b.backendInstance.read(r)];case 1:return[2,n.sent()]}}))}))},t.prototype.stopPredict=function(){this.isPaused=!0},t}(),yt=function(){}},993:()=>{}},e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={exports:{}};return t[n](i,i.exports,r),i.exports}return r.d=(t,e)=>{for(var n in e)r.o(e,n)&&!r.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},r.g=function(){if(\"object\"==typeof globalThis)return globalThis;try{return this||new Function(\"return this\")()}catch(t){if(\"object\"==typeof window)return window}}(),r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(t,\"__esModule\",{value:!0})},r(994)})()}));"]}